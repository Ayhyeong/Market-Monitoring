<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Market Monitoring — Notes (Read-only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- XSS 방지 -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <!-- Monaspace Web-Font: For Button -->
  <link rel="preload" href="/fonts/Monaspace Neon Var.woff2" as="font" type="font/woff2" crossorigin>
  
  <style>
    :root{
      --bg:#f8fafc; --panel:#ffffff; --line:#e5e7eb; --text:#111827; --muted:#6b7280;
      --brand:#4f46e5; --brand-2:#4338ca;
      --radius:14px;
      --sidebar-wide: 320px;
      --sidebar-compact: 80px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:var(--bg); color:var(--text);
    }

    /* App layout */
    .app{ display:flex; height:100svh; width:100%; max-width:100%; overflow:hidden; }
    .main{ min-width:0; }
    .editor{ min-width:0; }
    .editor .preview{ min-width:0; overflow-wrap:anywhere; word-break:break-word; }
    .editor .preview img, .editor .preview table{ max-width:100%; height:auto; }
    .editor .preview pre{ max-width:100%; overflow:auto; }
    
    /* Sidebar */
    .sidebar{
      background:var(--panel); border-right:1px solid var(--line);
      box-shadow:0 1px 6px rgba(0,0,0,.04); transition:width .25s ease;
      width: var(--sidebar-wide);
      position:relative; display:flex; flex-direction:column;
    }
    .sidebar.compact{ width: var(--sidebar-compact); }
    .s-top{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; padding:10px; border-bottom:1px solid var(--line);
    }
    .notes{ flex:1; overflow:auto; padding:8px; }

    /* Buttons */
    .btn{
      font-size:14px; padding:8px 12px; border:0; border-radius:12px; background:#f3f4f6; cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{ background:#e5e7eb; }
    .btn-link{ padding:0; background:transparent; color:var(--muted); border-radius:8px; }
    .btn[aria-expanded="true"]{ background:#e5e7eb; }

    /* Items */
    .item{
      position:relative; display:flex; gap:8px; align-items:center;
      padding:10px 12px; border-radius:12px; cursor:pointer; width:100%;
      background:transparent; border:0; text-align:left;
    }
    .item:hover{ background:#f3f4f6; }
    .item.active{ background:#eef2ff; outline:1px solid #c7d2fe; }
    .title{
      font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;
    }
    .more{
      opacity:0; transition:opacity .15s; color:#6b7280; font-weight:700; padding:0 6px;
    }
    .item:hover .more{ opacity:1; }

    /* Context menu */
    .menu{
      position:absolute; right:8px; top:38px; width:180px; background:#fff;
      border:1px solid var(--line); border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.08);
      overflow:hidden; z-index:3; padding:6px;
    }
    .menu [role="menuitem"]{
      width:100%; text-align:left; padding:10px 12px; background:#fff; border:0; font-size:14px; cursor:pointer; border-radius:8px;
    }
    .menu [role="menuitem"]:hover, .menu [role="menuitem"]:focus-visible{ background:#f3f4f6; outline:none; }

    /* Main */
    .main{ flex:1; display:flex; flex-direction:column; }
    .m-top{
      height:56px; display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; border-bottom:1px solid var(--line); background:#fff;
    }
    .heading{ font-weight:700; max-width:65%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Read-only preview area */
    .editor{
      flex:1; background:#fff; overflow:auto; padding:16px; line-height:1.7; font-size:15px;
    }
    .editor h1,.editor h2,.editor h3{ margin:1.2em 0 .6em; }
    .editor code{ background:#f3f4f6; padding:.2em .4em; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .editor pre code{ display:block; padding:12px; overflow:auto; }
    .editor blockquote{ border-left:4px solid #e5e7eb; padding-left:12px; color:#374151; }
    .editor ul, .editor ol{ padding-left:1.2em; }
    
    /* Compact rules */
    .sidebar.compact .hide-when-compact{ display:none !important; }
    .sidebar.compact .hide-control-when-compact{ display:none !important; }

    /* Focus visibility */
    :focus-visible{
      outline:2px solid #6366f1;
      outline-offset:2px;
      border-radius:10px;
    }

    /* Responsive widths refinement */
    @media (max-width: 480px){
      :root{ --sidebar-wide: 160px; --sidebar-compact: 48px; }
    }

    /* 1) Monaspace 가변 폰트 등록 */
    @font-face {
      font-family: 'Monaspace Neon';
      src: url('/fonts/Monaspace Neon Var.woff2') format('woff2-variations');
      font-weight: 200 800;          /* 가변 굵기 범위 */
      font-stretch: 75% 125%;        /* 가변 폭(있다면) */
      font-display: swap;
    }
    
    /* 버튼에만 Monaspace 적용 */
     button, .btn {
       font-family: 'Monaspace Neon', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
       font-variant-ligatures: contextual common-ligatures discretionary-ligatures;
       font-feature-settings: "calt" 1, "liga" 1, "clig" 1;
       font-synthesis-weight: none;
     }

  </style>
</head>
<body>
  <div id="app" class="app">
    <aside id="sidebar" class="sidebar" aria-label="노트 사이드바">
      <div class="s-top">
        <button type="button" class="btn hide-control-when-compact" id="homeBtn" title="홈" aria-label="홈으로 이동">홈</button>
        <button type="button" class="btn" id="toggleBtn" title="사이드바 열기/닫기" aria-controls="sidebar" aria-expanded="true">[|<]</button>
      </div>
      <div id="notesList" class="notes" role="list"></div>
    </aside>

    <section class="main">
      <div class="m-top">
        <div class="heading" id="heading">홈</div>
      </div>
      <div id="editor" class="editor" aria-live="polite">
        <div style="height:100%;display:grid;place-items:center;color:#6b7280">
          좌측에서 노트를 선택하세요.
        </div>
      </div>
    </section>
  </div>

  <script>
  // ======= Elements =======
  const $sidebar  = document.getElementById('sidebar');
  const $notesList= document.getElementById('notesList');
  const $heading  = document.getElementById('heading');
  const $editor   = document.getElementById('editor');
  const $toggleBtn= document.getElementById('toggleBtn');
  const $homeBtn  = document.getElementById('homeBtn');

  const uid = () => (crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2)+Date.now().toString(36)));

  // ======= Seed only =======
  function seed(){
    return [
      { id: uid(), order: 251020, title: '2025. 10. 27. Value Screening and Momentum Analysis',         contentUrl: 'content/251027.md' },
      { id: uid(), order: 251020, title: '2025. 10. 27. Weekly Macro Brief',         contentUrl: 'content/251027.txt' },
      { id: uid(), order: 251020, title: '2025. 10. 20. Weekly Macro Brief',         contentUrl: 'content/251020.txt' },
      { id: uid(), order: 251016, title: '2025. 10. 16. Daily Market Issues',         contentUrl: 'content/251016.txt' },
      { id: uid(), order: 251015, title: '2025. 10. 15. Euro Area Industrial Production', contentUrl: 'content/251015.txt' },
      { id: uid(), order: 251013, title: '2025. 10. 13. Weekly Macro Brief',          contentUrl: 'content/251013.txt' },
    ];
  }

  let notes = seed();
  let selectedId = null;
  let currentMenuAbort = null;

  // ======= Utils =======
  function sortLatest(a,b){
    const ao = (typeof a.order === 'number') ? a.order : 0;
    const bo = (typeof b.order === 'number') ? b.order : 0;
    return (bo - ao);
  }

  async function fetchText(url) {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('Load failed');
    return r.text();
  }

  function safeHtmlFromMarkdown(raw){
    const hasMarked = typeof marked !== 'undefined' && typeof marked.parse === 'function';
    const hasPurify = typeof DOMPurify !== 'undefined' && typeof DOMPurify.sanitize === 'function';
    if (hasMarked && hasPurify) return DOMPurify.sanitize(marked.parse(raw || ''));
    const esc = (s) => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return `<pre>${esc(raw)}</pre>`;
  }

  // ======= Renderers =======
  function renderList(){
    notes.sort(sortLatest);
    $notesList.innerHTML = '';
    $notesList.setAttribute('aria-label','노트 목록');

    notes.forEach(n => {
      const row = document.createElement('button');
      row.type = 'button';
      row.className = 'item' + (selectedId === n.id ? ' active' : '');
      row.setAttribute('role','listitem');
      row.setAttribute('aria-pressed', selectedId === n.id ? 'true' : 'false');
      row.addEventListener('click', () => {
        if ($sidebar.classList.contains('compact')) setSidebar(true);
        selectNote(n.id);
      });
      row.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          if ($sidebar.classList.contains('compact')) setSidebar(true);
          selectNote(n.id);
        }
      });

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = n.title || '(제목 없음)';

      const more = document.createElement('button');
      more.type = 'button';
      more.className = 'btn-link more';
      more.textContent = '…';
      more.title = '더보기';
      more.setAttribute('aria-haspopup','menu');
      more.setAttribute('aria-expanded','false');
      more.addEventListener('click', (e) => {
        e.stopPropagation(); openMenu(row, n, more);
      });

      row.appendChild(title);
      row.appendChild(more);
      $notesList.appendChild(row);
    });
  }

  async function renderMain(){
    if (!selectedId) {
      $heading.textContent = '홈';
      $editor.innerHTML = '<div style="height:100%;display:grid;place-items:center;color:#6b7280">좌측에서 노트를 선택하세요.</div>';
      return;
    }
    const note = notes.find(n => n.id === selectedId);
    if(!note){
      $heading.textContent = '홈';
      $editor.innerHTML = '<div style="height:100%;display:grid;place-items:center;color:#ef4444">존재하지 않는 노트입니다.</div>';
      return;
    }

    $heading.textContent = note.title || '(제목 없음)';
    $editor.innerHTML = '<div style="padding:16px;color:#6b7280">불러오는 중…</div>';

    try{
      const md = await fetchText(note.contentUrl);
      const html = safeHtmlFromMarkdown(md);
      $editor.innerHTML = `<article role="document">${html}</article>`;
    }catch{
      $editor.innerHTML = '<div style="color:#ef4444">콘텐츠를 불러오지 못했습니다.</div>';
    }
  }

  // ======= Menu =======
  function openMenu(anchorEl, note, buttonEl){
    closeMenus();
    const menu = document.createElement('div');
    menu.className = 'menu';
    menu.setAttribute('role','menu');
    menu.setAttribute('aria-label','노트 메뉴');

    const shareBtn = document.createElement('button');
    shareBtn.type = 'button';
    shareBtn.textContent = '링크 복사';
    shareBtn.setAttribute('role','menuitem');
    shareBtn.addEventListener('click', (e) => { e.stopPropagation(); copyShareLink(note.id); closeMenus(); });

    menu.appendChild(shareBtn);
    anchorEl.appendChild(menu);

    buttonEl.setAttribute('aria-expanded','true');
    shareBtn.focus();

    currentMenuAbort = new AbortController();
    const { signal } = currentMenuAbort;

    document.addEventListener('mousedown', (ev) => {
      if(!menu.contains(ev.target)) { closeMenus(true, buttonEl); }
    }, { signal });

    document.addEventListener('keydown', (ev) => {
      if(ev.key === 'Escape') { ev.preventDefault(); closeMenus(true, buttonEl); }
    }, { signal });
  }

  function closeMenus(focusBack = false, btn = null){
    document.querySelectorAll('.menu').forEach(m => m.remove());
    if(currentMenuAbort){ currentMenuAbort.abort(); currentMenuAbort = null; }
    if(btn){ btn.setAttribute('aria-expanded','false'); if(focusBack) btn.focus(); }
  }

  // ======= Routing / Selection =======
  function selectNote(id){
    selectedId = id;
    const url = new URL(window.location.href);
    url.searchParams.set('note', id);
    history.replaceState(null, '', url.toString());
    renderList(); renderMain();
  }

  function bootSelectFromQuery(){
    const q = new URL(location.href).searchParams.get('note');
    if(q && notes.some(n => n.id === q)) selectedId = q;
    else if(q) toast('존재하지 않는 노트 링크입니다.');
  }

  // ======= Clipboard =======
  function copyShareLink(id){
    const url = `${location.origin}${location.pathname}?note=${encodeURIComponent(id)}`;
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(url).then(() => toast('공유 링크가 복사되었습니다.'), () => fallbackCopy(url));
    } else { fallbackCopy(url); }
  }
  function fallbackCopy(text){
    const i = document.createElement('input');
    i.value = text; document.body.appendChild(i);
    i.select(); document.execCommand('copy'); i.remove();
    toast('공유 링크가 복사되었습니다.');
  }

  // ======= Toast =======
  function toast(msg){
    const prev = document.querySelector('.toast'); if(prev) prev.remove();
    const t = document.createElement('div');
    t.className = 'toast'; t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 1600);
  }

  // ======= Sidebar toggle =======
  function setSidebar(open){
    const isMobile = window.matchMedia('(max-width: 480px)').matches;
    if(open){
      $sidebar.classList.remove('compact');
      $toggleBtn.textContent = isMobile ? '<' : '[|<]';
      $toggleBtn.setAttribute('aria-expanded','true');
    } else {
      $sidebar.classList.add('compact');
      $toggleBtn.textContent = isMobile ? '>' : '[>|]';
      $toggleBtn.setAttribute('aria-expanded','false');
    }
  }
  $toggleBtn.addEventListener('click', () => {
    const isCompact = $sidebar.classList.contains('compact');
    setSidebar(isCompact);
  });
  $homeBtn.addEventListener('click', () => {
    selectedId = null;
    const url = new URL(location.href);
    url.searchParams.delete('note');
    history.replaceState(null, '', url.toString());
    renderList(); renderMain();
  });

  // ======= Init =======
  function init(){
    bootSelectFromQuery();
    renderList();
    renderMain();
    setSidebar(true);
  }
  init();
</script>

</body>
</html>
